name: Sync to Hugging Face Hub
on:
  push:
    branches: [main]

  workflow_dispatch: {}

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Install git-lfs
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install

      - name: Push to hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          # Preferred: set HF_SPACE_ID secret to "<username>/<space_name>" (e.g. "anayush1406/f1-replay-backend")
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
          # Backwards-compatible fallback (avoid editing workflow): set these as repo secrets if you prefer
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          set -euo pipefail

          if [ -z "$HF_TOKEN" ]; then
            echo "Error: HF_TOKEN secret is not set."
            exit 1
          fi

          if [ -z "$HF_SPACE_ID" ]; then
            if [ -n "$HF_USERNAME" ] && [ -n "$HF_SPACE_NAME" ]; then
              HF_SPACE_ID="$HF_USERNAME/$HF_SPACE_NAME"
            else
              echo "Error: HF_SPACE_ID secret is not set (and HF_USERNAME/HF_SPACE_NAME fallback not provided)."
              exit 1
            fi
          fi

          HF_USER="${HF_SPACE_ID%%/*}"
          HF_URL="https://huggingface.co/spaces/${HF_SPACE_ID}"
          # Use oauth2 token auth (more reliable than username:token)
          HF_PUSH_URL="https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE_ID}"

          echo "Pushing to: ${HF_URL}"

          echo "Preflight auth check (ls-remote)…"
          # This gives a clearer error when the token is missing permissions or the space id is wrong.
          git ls-remote "$HF_PUSH_URL" >/dev/null
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # Hugging Face rejects files >10MB in normal git pushes.
          # This repo contains large local data (e.g. f1_data_2025_abudhabi/telemetry.csv),
          # so we deploy a clean snapshot containing only what the Space needs.
          DEPLOY_DIR="$(mktemp -d)"
          echo "Creating deploy snapshot in: ${DEPLOY_DIR}"

          # Copy only the runtime-required files
          mkdir -p "${DEPLOY_DIR}/backend"
          cp -R backend/* "${DEPLOY_DIR}/backend/"
          cp Dockerfile "${DEPLOY_DIR}/Dockerfile"
          # Optional docs (safe and small)
          [ -f README.md ] && cp README.md "${DEPLOY_DIR}/README.md" || true

          cd "${DEPLOY_DIR}"
          git init
          git add -A
          git commit -m "Deploy snapshot from ${GITHUB_SHA}" || true
          git branch -M main
          git remote add hf "${HF_PUSH_URL}"

          echo "Force pushing snapshot to Hugging Face…"
          git push --force hf main
